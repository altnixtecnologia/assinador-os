<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrador - Assinador de O.S.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .modal { display: none; }
        .modal.active { display: flex; }
        .btn-disabled { cursor: not-allowed; opacity: 0.5; }
        .pdf-preview-container { max-height: 75vh; overflow-y: auto; }
        #pdf-drawing-canvas { position: absolute; top: 0; left: 0; cursor: crosshair; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 2rem; height: 2rem; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">

    <div class="w-full max-w-6xl mx-auto bg-white rounded-lg shadow-md p-8">
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-6 border-b pb-4">Painel de Assinaturas</h1>

        <!-- A tela inicial agora é um container que o JS vai preencher -->
        <div id="initial-view" class="text-center py-8">
            <!-- Conteúdo será preenchido pelo JS -->
        </div>

        <div id="preparation-view" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Preparação do Documento</h2>
                <button id="cancel-preparation-btn" class="text-sm text-gray-600 hover:underline">Cancelar e Voltar</button>
            </div>
            <div class="flex flex-col md:flex-row gap-8">
                <div class="w-full md:w-2/3 border rounded-lg p-4 bg-gray-50">
                    <p id="instruction-text" class="text-center font-semibold text-blue-700 mb-4 p-2 bg-blue-100 rounded"></p>
                    <div id="pdf-preview-wrapper" class="relative w-full pdf-preview-container bg-white border"></div>
                </div>
                <div class="w-full md:w-1/3">
                    <form id="upload-form" class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-700 border-b pb-2">Dados do Cliente (Editáveis)</h3>
                        <div>
                            <label for="cliente-nome" class="block text-sm font-medium text-gray-700">Nome do Cliente</label>
                            <input type="text" id="cliente-nome" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white">
                        </div>
                        <div>
                            <label for="cliente-telefone" class="block text-sm font-medium text-gray-700">Telefone para WhatsApp</label>
                            <input type="tel" id="cliente-telefone" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white">
                        </div>
                        <div>
                            <label for="cliente-email" class="block text-sm font-medium text-gray-700">E-mail</label>
                            <input type="email" id="cliente-email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white">
                        </div>
                        <div class="pt-4">
                            <button type="submit" id="submit-button" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                                Gerar Link de Assinatura
                            </button>
                        </div>
                    </form>
                    <div id="feedback-message" class="mt-4 text-center text-sm"></div>
                    <div id="actions-container" class="mt-6 hidden space-y-4">
                        <div id="link-gerado-container">
                            <label class="block text-sm font-medium text-gray-700">Link Gerado com Sucesso!</label>
                            <div class="mt-1 flex rounded-md shadow-sm">
                                <input type="text" id="link-gerado-input" readonly class="flex-1 block w-full rounded-none rounded-l-md sm:text-sm border-gray-300 bg-gray-50 p-2">
                                <button type="button" id="copiar-link-btn" class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-700 text-sm hover:bg-gray-100">
                                    Copiar
                                </button>
                            </div>
                        </div>
                        <div id="whatsapp-container" class="hidden">
                             <button type="button" id="whatsapp-btn" class="mt-1 w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                                Enviar via WhatsApp
                            </button>
                        </div>
                        <div id="post-generation-nav" class="pt-4 space-y-2 border-t mt-4">
                            <button id="nav-to-new-btn" class="w-full text-center py-2 px-4 rounded-md text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">Enviar Novo Documento</button>
                            <button id="nav-to-consult-btn" class="w-full text-center py-2 px-4 rounded-md text-sm font-medium text-white bg-gray-600 hover:bg-gray-700">Consultar Enviados</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="consultation-view" class="hidden mt-10">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h2 class="text-2xl font-bold text-gray-800">Consulta de Documentos</h2>
                <div class="flex items-center gap-4">
                    <button id="refresh-list-btn" class="text-sm text-blue-600 hover:underline">Atualizar Lista</button>
                    <button id="back-to-initial-view-btn" class="text-sm text-blue-600 hover:underline">Voltar para o Início</button>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row gap-4 mb-6">
                <div class="flex-shrink-0">
                    <span class="text-sm font-medium text-gray-700">Status Assinatura:</span>
                    <div id="status-filter-buttons" class="mt-1 inline-flex rounded-md shadow-sm">
                        <button data-status="todos" class="px-4 py-2 bg-blue-600 text-white border border-gray-300 rounded-l-md text-sm font-medium">Todos</button>
                        <button data-status="assinado" class="px-4 py-2 bg-white border-t border-b border-gray-300 text-gray-700 hover:bg-gray-50 text-sm font-medium">Assinados</button>
                        <button data-status="pendente" class="px-4 py-2 bg-white border border-gray-300 rounded-r-md text-gray-700 hover:bg-gray-50 text-sm font-medium">Pendentes</button>
                    </div>
                </div>
                <div class="flex-grow">
                     <label for="search-input" class="text-sm font-medium text-gray-700">Busca Universal:</label>
                     <input type="text" id="search-input" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Nome, OS, status do serviço...">
                </div>
            </div>
            <div id="document-list" class="space-y-4">
                <p id="list-loading-feedback" class="text-center text-gray-500 py-8">Carregando documentos...</p>
            </div>
            <div id="pagination-controls" class="flex justify-between items-center mt-6 border-t pt-4">
                <button id="prev-page-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md text-sm font-medium hover:bg-gray-300 btn-disabled">Anterior</button>
                <span id="page-info" class="text-sm text-gray-600"></span>
                <button id="next-page-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md text-sm font-medium hover:bg-gray-300 btn-disabled">Próxima</button>
            </div>
        </div>
    </div>
    
    <div id="details-modal" class="modal fixed inset-0 bg-gray-800 bg-opacity-75 items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-full overflow-y-auto p-6 relative">
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
            <h3 class="text-xl font-bold mb-4 border-b pb-2">Detalhes da Assinatura</h3>
            <div id="modal-content" class="space-y-4 text-sm"></div>
        </div>
    </div>
    <div id="delete-confirm-modal" class="modal fixed inset-0 bg-gray-800 bg-opacity-75 items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Confirmar Exclusão</h3>
            <p class="text-sm text-gray-600 mb-4">Você está prestes a excluir este documento e todos os seus registros de assinatura permanentemente. Esta ação não pode ser desfeita.</p>
            <div class="flex items-center mb-6">
                <input id="delete-checkbox" type="checkbox" class="h-4 w-4 text-red-600 border-gray-300 rounded">
                <label for="delete-checkbox" class="ml-2 block text-sm text-gray-900">Sim, eu entendo e quero excluir.</label>
            </div>
            <div class="flex justify-end gap-4">
                <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md text-sm font-medium hover:bg-gray-300">Cancelar</button>
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-md text-sm font-medium btn-disabled">Confirmar Exclusão</button>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script type="module" src="js/admin.js"></script>
</body>
</html>
```

---
### **Passo 2: Atualize o `admin.js`**

Este arquivo agora contém a lógica completa e correta para a nova interface e para o fluxo de importação pelo bookmarklet.

**Arquivo: `js/admin.js` (100% COMPLETO E FINAL)**
```javascript
// js/admin.js
import { SITE_BASE_URL, ITENS_PER_PAGE } from './config.js';
import * as db from './supabaseService.js';
import { setupPdfWorker, extractDataFromPdf } from './pdfHandler.js';

setupPdfWorker();

document.addEventListener('DOMContentLoaded', () => {
    // --- Elementos da UI ---
    const osFileInput = document.getElementById('os-file');
    const uploadInitialView = document.getElementById('initial-view');
    const preparationView = document.getElementById('preparation-view');
    const cancelPreparationBtn = document.getElementById('cancel-preparation-btn');
    const instructionText = document.getElementById('instruction-text');
    const pdfPreviewWrapper = document.getElementById('pdf-preview-wrapper');
    const uploadForm = document.getElementById('upload-form');
    const clienteNomeInput = document.getElementById('cliente-nome');
    const clienteTelefoneInput = document.getElementById('cliente-telefone');
    const clienteEmailInput = document.getElementById('cliente-email');
    const submitButton = document.getElementById('submit-button');
    const feedbackMessage = document.getElementById('feedback-message');
    const actionsContainer = document.getElementById('actions-container');
    const linkInput = document.getElementById('link-gerado-input');
    const copiarBtn = document.getElementById('copiar-link-btn');
    const whatsappBtn = document.getElementById('whatsapp-btn');
    const whatsappContainer = document.getElementById('whatsapp-container');
    const consultationView = document.getElementById('consultation-view');
    const backToInitialViewBtn = document.getElementById('back-to-initial-view-btn');
    const documentList = document.getElementById('document-list');
    const listLoadingFeedback = document.getElementById('list-loading-feedback');
    const statusFilterButtons = document.getElementById('status-filter-buttons');
    const searchInput = document.getElementById('search-input');
    const detailsModal = document.getElementById('details-modal');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const modalContent = document.getElementById('modal-content');
    const prevPageBtn = document.getElementById('prev-page-btn');
    const nextPageBtn = document.getElementById('next-page-btn');
    const pageInfo = document.getElementById('page-info');
    const deleteConfirmModal = document.getElementById('delete-confirm-modal');
    const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    const deleteCheckbox = document.getElementById('delete-checkbox');
    const navToNewBtn = document.getElementById('nav-to-new-btn');
    const navToConsultBtn = document.getElementById('nav-to-consult-btn');
    const refreshListBtn = document.getElementById('refresh-list-btn');
    
    // --- Estado do Aplicativo ---
    let pdfDoc = null;
    let currentFile = null;
    let currentDrawingFor = 'tecnico';
    let isDrawing = false;
    let startCoords = { x: 0, y: 0 };
    let rects = { tecnico: null, cliente: null };
    let pageDimensions = [];
    let allDocumentsData = [];
    let currentPage = 0;
    let totalDocuments = 0;
    let currentStatusFilter = 'todos';
    let currentSearchTerm = '';
    let debounceTimer;
    let docIdParaExcluir = null;
    let extractedDataFromPdf = {};
    let currentErpLink = null; 

    // --- Funções de UI e Lógica Principal ---
    function renderInitialView() {
        uploadInitialView.innerHTML = `
            <div class="space-y-4">
                <label for="os-file-dynamic" class="w-full max-w-md mx-auto cursor-pointer bg-blue-600 text-white font-bold py-4 px-6 rounded-lg hover:bg-blue-700 transition duration-300 inline-flex items-center justify-center text-xl">
                    + Enviar Nova Ordem de Serviço
                </label>
                <input type="file" id="os-file-dynamic" class="hidden" accept="application/pdf"/>
                <br>
                <button id="show-consultation-btn-dynamic" class="w-full max-w-md mx-auto cursor-pointer bg-gray-600 text-white font-bold py-4 px-6 rounded-lg hover:bg-gray-700 transition duration-300 inline-flex items-center justify-center text-xl">
                    Consultar Documentos Enviados
                </button>
            </div>
        `;
        document.getElementById('os-file-dynamic').addEventListener('change', handleFileSelect);
        document.getElementById('show-consultation-btn-dynamic').addEventListener('click', showConsultationScreen);
    }
    
    function showInitialView() {
        preparationView.style.display = 'none';
        consultationView.style.display = 'none';
        uploadInitialView.style.display = 'block';
        renderInitialView();
    }

    function showConsultationScreen() {
        uploadInitialView.style.display = 'none';
        preparationView.style.display = 'none';
        consultationView.style.display = 'block';
        carregarDocumentos();
    }

    async function startPreparationProcess(source, fileName = '', erpLink = null) {
        currentErpLink = erpLink;
        uploadInitialView.style.display = 'none';
        consultationView.style.display = 'none';
        preparationView.style.display = 'block';
        showFeedback('Extraindo dados do PDF...', 'info');

        try {
            if (source instanceof File) {
                currentFile = source;
            } else { // É uma URL (path do storage)
                const publicUrl = db.getPublicUrl(source);
                const response = await fetch(publicUrl);
                if (!response.ok) throw new Error(`Falha ao buscar PDF da URL.`);
                const blob = await response.blob();
                currentFile = new File([blob], fileName || 'documento.pdf', { type: 'application/pdf' });
                currentFile.internalPath = source; 
            }
            
            extractedDataFromPdf = await extractDataFromPdf(currentFile);
            clienteNomeInput.value = extractedDataFromPdf.nome;
            clienteTelefoneInput.value = extractedDataFromPdf.telefone;
            clienteEmailInput.value = extractedDataFromPdf.email;
            showFeedback('Dados extraídos! Prossiga com a marcação das assinaturas.', 'success');

            const fileReader = new FileReader();
            fileReader.onload = async function() {
                const pdfBytes = new Uint8Array(this.result);
                pdfDoc = await pdfjsLib.getDocument(pdfBytes).promise;
                await renderPdfPreview();
            };
            fileReader.readAsArrayBuffer(currentFile);
            
            instructionText.textContent = "1/2: Desenhe a área para a assinatura do TÉCNICO.";
            currentDrawingFor = 'tecnico';

        } catch (error) {
            showFeedback(`Erro ao processar documento: ${error.message}`, 'error');
            setTimeout(showInitialView, 3000);
        }
    }

    function showFeedback(message, type = 'info', element = feedbackMessage) {
        const colorClasses = { success: 'text-green-600', error: 'text-red-600', info: 'text-blue-600' };
        element.textContent = message;
        element.className = `mt-4 text-center text-sm ${colorClasses[type] || 'text-gray-600'}`;
    }

    function setLoading(isLoading) {
        if (isLoading) {
            submitButton.disabled = true;
            submitButton.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Gerando...`;
        } else {
            submitButton.disabled = false;
            submitButton.textContent = 'Gerar Link de Assinatura';
        }
    }
    
    function resetPreparationView() {
        showInitialView();
        osFileInput.value = '';
        pdfDoc = null;
        currentFile = null;
        rects = { tecnico: null, cliente: null };
        pdfPreviewWrapper.innerHTML = '';
        showFeedback('', 'info');
        actionsContainer.classList.add('hidden');
    }
    
    async function renderPdfPreview() {
        if (!pdfDoc) return;
        pdfPreviewWrapper.innerHTML = '';
        pageDimensions = [];
        const containerWidth = pdfPreviewWrapper.clientWidth;
        let totalHeight = 0;
        const pages = [];
        for (let i = 1; i <= pdfDoc.numPages; i++) {
            const page = await pdfDoc.getPage(i);
            pages.push(page);
            const viewport = page.getViewport({ scale: 1.0 });
            const scaledHeight = (containerWidth / viewport.width) * viewport.height;
            pageDimensions.push({ num: i, width: viewport.width, height: viewport.height, scaledHeight });
            totalHeight += scaledHeight;
        }
        const bgCanvas = document.createElement('canvas');
        bgCanvas.id = 'pdf-background-canvas';
        const drawCanvas = document.createElement('canvas');
        drawCanvas.id = 'pdf-drawing-canvas';
        pdfPreviewWrapper.appendChild(bgCanvas);
        pdfPreviewWrapper.appendChild(drawCanvas);
        bgCanvas.width = drawCanvas.width = containerWidth;
        bgCanvas.height = drawCanvas.height = totalHeight;
        drawCanvas.style.position = 'absolute';
        drawCanvas.style.top = '0';
        drawCanvas.style.left = '0';
        const bgCtx = bgCanvas.getContext('2d');
        let currentY = 0;
        for (let i = 0; i < pages.length; i++) {
            const page = pages[i];
            const scaledViewport = page.getViewport({ scale: containerWidth / page.getViewport({ scale: 1.0 }).width });
            const renderContext = { canvasContext: bgCtx, transform: [1, 0, 0, 1, 0, currentY], viewport: scaledViewport };
            await page.render(renderContext).promise;
            currentY += scaledViewport.height;
        }
        drawCanvas.addEventListener('mousedown', startDrawing);
        drawCanvas.addEventListener('mousemove', draw);
        drawCanvas.addEventListener('mouseup', stopDrawing);
        redrawAll();
    }

    function startDrawing(event) {
        isDrawing = true;
        startCoords = getMousePos(event.target, event);
    }

    function draw(event) {
        if (!isDrawing) return;
        redrawAll();
        const currentCoords = getMousePos(event.target, event);
        const width = currentCoords.x - startCoords.x;
        const height = currentCoords.y - startCoords.y;
        const tempRect = { x: startCoords.x, y: startCoords.y, width, height };
        const color = currentDrawingFor === 'tecnico' ? 'rgba(255, 0, 0, 0.4)' : 'rgba(0, 0, 255, 0.4)';
        drawRectOnCanvas(tempRect, color);
    }

    function stopDrawing(event) {
        if (!isDrawing) return;
        isDrawing = false;
        const endCoords = getMousePos(event.target, event);
        const rect = {
            x: Math.min(startCoords.x, endCoords.x),
            y: Math.min(startCoords.y, endCoords.y),
            width: Math.abs(startCoords.x - endCoords.x),
            height: Math.abs(startCoords.y - endCoords.y)
        };
        if (rect.width < 10 || rect.height < 10) { redrawAll(); return; }
        if (currentDrawingFor === 'tecnico') {
            rects.tecnico = rect;
            currentDrawingFor = 'cliente';
            instructionText.textContent = "2/2: Agora, desenhe a área para a assinatura do CLIENTE.";
        } else if (currentDrawingFor === 'cliente') {
            rects.cliente = rect;
            instructionText.textContent = "Áreas definidas! Verifique os dados e gere o link.";
        }
        redrawAll();
    }

    function redrawAll() {
        const drawCanvas = document.getElementById('pdf-drawing-canvas');
        if (!drawCanvas) return;
        const drawCtx = drawCanvas.getContext('2d');
        drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
        drawRectOnCanvas(rects.tecnico, 'rgba(255, 0, 0, 0.4)', 'Técnico');
        drawRectOnCanvas(rects.cliente, 'rgba(0, 0, 255, 0.4)', 'Cliente');
    }

    function getMousePos(canvas, evt) {
        const rect = canvas.getBoundingClientRect();
        return { x: evt.clientX - rect.left, y: evt.clientY - rect.top };
    }

    function drawRectOnCanvas(rect, color, label = '') {
        const drawCanvas = document.getElementById('pdf-drawing-canvas');
        if (!drawCanvas || !rect) return;
        const drawCtx = drawCanvas.getContext('2d');
        drawCtx.fillStyle = color;
        drawCtx.fillRect(rect.x, rect.y, rect.width, rect.height);
        if (label) {
            drawCtx.fillStyle = '#fff';
            drawCtx.font = 'bold 12px sans-serif';
            drawCtx.fillText(label, rect.x + 5, rect.y + 15);
        }
    }
    
    async function carregarDocumentos() {
        listLoadingFeedback.style.display = 'block';
        listLoadingFeedback.textContent = "Carregando documentos...";
        documentList.innerHTML = '';
        try {
            const { data, error, count } = await db.getDocuments(currentPage, ITENS_PER_PAGE, currentStatusFilter, currentSearchTerm);
            if (error) throw error;
            allDocumentsData = data;
            totalDocuments = count;
            renderizarLista(data);
            atualizarControlesPaginacao();
        } catch (error) {
            documentList.innerHTML = `<p class="text-center text-red-500 py-8">Erro ao carregar documentos: ${error.message}</p>`;
        } finally {
            listLoadingFeedback.style.display = 'none';
        }
    }

    function renderizarLista(docs) {
        documentList.innerHTML = '';
        if (!docs || docs.length === 0) {
            documentList.innerHTML = '<p class="text-center text-gray-500 py-8">Nenhum documento encontrado.</p>';
            return;
        }
        docs.forEach(doc => {
            const card = document.createElement('div');
            card.className = 'border rounded-lg p-4 bg-gray-50 shadow-sm';
            const dataEnvio = new Date(doc.created_at).toLocaleDateString('pt-BR');
            const nomeArquivoOriginal = doc.caminho_arquivo_storage.split('-').slice(1).join('-') || doc.caminho_arquivo_storage;
            
            let statusHtml = '';
            let actionsHtml = '';

            if (doc.status === 'assinado') {
                statusHtml = `<span class="text-xs font-medium px-2.5 py-1 rounded-full bg-green-100 text-green-800">Assinado ✅</span>`;
                const assinatura = doc.assinaturas && doc.assinaturas.length > 0 ? doc.assinaturas[0] : null;
                actionsHtml = `
                    <button class="download-btn text-sm text-blue-600 hover:underline" data-path="${doc.caminho_arquivo_storage}">Original</button>
                    ${doc.caminho_arquivo_assinado ? `<button class="download-btn text-sm text-green-600 hover:underline" data-path="${doc.caminho_arquivo_assinado}">Assinado</button>` : ''}
                    ${assinatura ? `<button class="ver-detalhes-btn text-sm text-gray-600 hover:underline" data-doc-id="${doc.id}">Detalhes</button>` : ''}
                `;
            } else { // Pendente
                statusHtml = `<span class="text-xs font-medium px-2.5 py-1 rounded-full bg-yellow-100 text-yellow-800">Pendente ⏳</span>`;
                actionsHtml = `<button class="download-btn text-sm text-blue-600 hover:underline" data-path="${doc.caminho_arquivo_storage}">Original</button>`;
                actionsHtml += ` <button class="copy-link-btn text-sm text-purple-600 hover:underline" data-doc-id="${doc.id}">Copiar Link</button>`;
            }

            card.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4">
                    <div class="flex-grow min-w-0">
                        <p class="font-bold text-gray-800 break-all">${nomeArquivoOriginal}</p>
                        <p class="text-sm text-gray-500 truncate">${doc.nome_cliente ? `Cliente: ${doc.nome_cliente}` : ''}</p>
                        ${doc.n_os ? `<p class="text-sm text-gray-500 font-semibold">OS N°: ${doc.n_os}</p>` : ''}
                    </div>
                    <div class="flex-shrink-0 flex flex-col sm:flex-row items-start sm:items-center gap-4">
                        <div class="flex flex-col items-start sm:items-end text-right">
                            ${statusHtml}
                            ${doc.status_os ? `<span class="text-xs font-semibold mt-1 text-blue-800 bg-blue-100 px-2 py-0.5 rounded-full" title="Status do Serviço">${doc.status_os}</span>` : ''}
                        </div>
                        <span class="text-sm text-gray-600">Enviado em: ${dataEnvio}</span>
                        <div class="flex gap-2 flex-wrap">
                            ${actionsHtml}
                            <button class="excluir-btn text-sm text-red-600 hover:underline" data-doc-id="${doc.id}">Excluir</button>
                        </div>
                    </div>
                </div>`;
            documentList.appendChild(card);
        });
    }
    
    function abrirExclusaoModal(docId) {
        docIdParaExcluir = docId;
        deleteCheckbox.checked = false;
        confirmDeleteBtn.disabled = true;
        confirmDeleteBtn.classList.add('btn-disabled');
        deleteConfirmModal.classList.add('active');
    }

    async function executarExclusao() {
        if (!docIdParaExcluir) return;
        confirmDeleteBtn.disabled = true;
        confirmDeleteBtn.textContent = 'Excluindo...';
        try {
            await db.deleteDocument(docIdParaExcluir);
            showFeedback('Documento excluído com sucesso!', 'success');
            fecharModalExclusao();
            await carregarDocumentos();
        } catch (error) {
            showFeedback(`Erro ao excluir o documento: ${error.message}`, 'error');
        } finally {
            confirmDeleteBtn.disabled = false;
            confirmDeleteBtn.textContent = 'Confirmar Exclusão';
        }
    }

    function fecharModalExclusao() {
        docIdParaExcluir = null;
        deleteConfirmModal.classList.remove('active');
    }

    function abrirModalDetalhes(doc) {
        const assinatura = doc.assinaturas && doc.assinaturas.length > 0 ? doc.assinaturas[0] : null;
        const erpLinkHtml = doc.erp_link 
            ? `<p><strong>Link do ERP:</strong> <a href="${doc.erp_link}" target="_blank" class="text-blue-600 hover:underline">Abrir no ERP</a></p>` 
            : '';
        modalContent.innerHTML = `
            <h4 class="font-bold">Documento</h4>
            <p><strong>Nome Original:</strong> ${doc.caminho_arquivo_storage.split('-').slice(1).join('-')}</p>
            ${erpLinkHtml}
            <p><strong>Enviado em:</strong> ${new Date(doc.created_at).toLocaleString('pt-BR')}</p>
            <p><strong>Nº da O.S.:</strong> ${doc.n_os || 'Não informado'}</p>
            <p><strong>Status do Serviço:</strong> ${doc.status_os || 'Não informado'}</p>
            <p><strong>Cliente:</strong> ${doc.nome_cliente || 'Não informado'}</p>
            ${assinatura ? `
            <hr class="my-4">
            <h4 class="font-bold">Dados da Assinatura</h4>
            <p><strong>Nome do Assinante:</strong> ${assinatura.nome_signatario || 'Não informado'}</p>
            <p><strong>Email:</strong> ${assinatura.email_signatario || 'Não informado'}</p>
            <p><strong>CPF/CNPJ:</strong> ${assinatura.cpf_cnpj_signatario || 'Não informado'}</p>
            <p><strong>Data da Assinatura:</strong> ${assinatura.data_hora_local || new Date(assinatura.assinado_em).toLocaleString('pt-BR')}</p>
            <p><strong>ID Google:</strong> ${assinatura.google_user_id || 'Não informado'}</p>
            <p><strong>Endereço IP:</strong> ${assinatura.ip_signatario || 'Não informado'}</p>
            <div>
                <p><strong>Assinatura Gráfica:</strong></p>
                <img src="${assinatura.imagem_assinatura_base64}" class="border mt-2 w-full max-w-sm" alt="Assinatura">
            </div>` : ''}
        `;
        detailsModal.classList.add('active');
    }

    function atualizarControlesPaginacao() {
        const totalPages = Math.ceil(totalDocuments / ITENS_PER_PAGE);
        pageInfo.textContent = totalDocuments > 0 ? `Página ${currentPage + 1} de ${totalPages || 1}` : 'Nenhum resultado';
        prevPageBtn.disabled = currentPage === 0;
        prevPageBtn.classList.toggle('btn-disabled', currentPage === 0);
        nextPageBtn.disabled = (currentPage + 1) >= totalPages;
        nextPageBtn.classList.toggle('btn-disabled', (currentPage + 1) >= totalPages);
    }
    
    function sanitizarNomeArquivo(nome) {
        const comAcentos = 'àáâãäåæçèéêëìíîïðñòóôõöøùúûüýþßŕ';
        const semAcentos = 'aaaaaaaceeeeiiiionoooooouuuuybsr';
        let novoNome = nome.toLowerCase();
        for (let i = 0; i < comAcentos.length; i++) {
            novoNome = novoNome.replace(new RegExp(comAcentos.charAt(i), 'g'), semAcentos.charAt(i));
        }
        return novoNome
            .replace(/[^a-z0-9.\-_]/g, '-')
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-');
    }

    // --- Event Listeners ---
    cancelPreparationBtn.addEventListener('click', resetPreparationView);
    backToInitialViewBtn.addEventListener('click', showInitialView);
    refreshListBtn.addEventListener('click', carregarDocumentos);

    uploadForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!rects.tecnico || !rects.cliente) {
            showFeedback("Defina as áreas de assinatura para o técnico e cliente.", "error");
            return;
        }
        const convertCoords = (rect) => {
             if (!rect) return null;
             let yOffset = 0;
             let pageNum = 0;
             for(let i=0; i<pageDimensions.length; i++){
                 if(rect.y < yOffset + pageDimensions[i].scaledHeight){
                     pageNum = i + 1;
                     break;
                 }
                 yOffset += pageDimensions[i].scaledHeight;
             }
             if(pageNum === 0) pageNum = pageDimensions.length;
             const pageDim = pageDimensions[pageNum-1];
             const canvasWidth = document.getElementById('pdf-background-canvas').width;
             const scale = pageDim.width / canvasWidth;
             return { page: pageNum, x: rect.x * scale, y: pageDim.height - ((rect.y - yOffset) * scale) - (rect.height * scale), width: rect.width * scale, height: rect.height * scale };
        };

        setLoading(true);
        try {
            let storagePath;
            if (currentFile.internalPath) {
                storagePath = currentFile.internalPath;
            } else {
                storagePath = `${Date.now()}-${sanitizarNomeArquivo(currentFile.name)}`;
                await db.uploadFile(storagePath, currentFile);
            }
            
            const documentRecord = {
                caminho_arquivo_storage: storagePath,
                nome_cliente: clienteNomeInput.value || null,
                telefone_cliente: clienteTelefoneInput.value || null,
                cliente_email: clienteEmailInput.value || null,
                n_os: extractedDataFromPdf.n_os || null,
                status_os: extractedDataFromPdf.status_os || null,
                tecnico_assinatura_coords: convertCoords(rects.tecnico),
                cliente_assinatura_coords: convertCoords(rects.cliente),
                erp_link: currentErpLink,
            };

            const insertData = await db.createDocumentRecord(documentRecord);
            const linkDeAssinatura = `${SITE_BASE_URL}/assinar.html?id=${insertData.id}`;
            linkInput.value = linkDeAssinatura;

            await db.updateDocumentLink(insertData.id, linkDeAssinatura);
            
            actionsContainer.classList.remove('hidden');
            whatsappContainer.style.display = clienteTelefoneInput.value ? 'block' : 'none';
            showFeedback('Link gerado e salvo com sucesso!', 'success');

        } catch (error) {
            console.error('Erro no processo de envio:', error);
            showFeedback(`Erro: ${error.message}`, 'error');
        } finally {
            setLoading(false);
        }
    });

    copiarBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(linkInput.value);
        copiarBtn.textContent = 'Copiado!';
        setTimeout(() => { copiarBtn.textContent = 'Copiar'; }, 2000);
    });

    whatsappBtn.addEventListener('click', () => {
        const telefone = clienteTelefoneInput.value.replace(/\D/g, '');
        const telefoneCompleto = telefone.length > 11 ? telefone : `55${telefone}`;
        const mensagem = encodeURIComponent(`Olá! Por favor, assine a Ordem de Serviço acessando o link: ${linkInput.value}`);
        window.open(`https://wa.me/${telefoneCompleto}?text=${mensagem}`, '_blank');
    });

    documentList.addEventListener('click', async (e) => {
        const target = e.target;
        if (target.classList.contains('download-btn')) {
            const path = target.dataset.path;
            const publicUrl = db.getPublicUrl(path);
            window.open(publicUrl, '_blank');
        }
        if (target.classList.contains('ver-detalhes-btn')) {
            const docId = target.dataset.docId;
            const doc = allDocumentsData.find(d => d.id.toString() === docId);
            if (doc) abrirModalDetalhes(doc);
        }
        if (target.classList.contains('excluir-btn')) {
            abrirExclusaoModal(target.dataset.docId);
        }
        if (target.classList.contains('copy-link-btn')) {
            const docId = target.dataset.docId;
            const link = `${SITE_BASE_URL}/assinar.html?id=${docId}`;
            navigator.clipboard.writeText(link);
            target.textContent = 'Copiado!';
            setTimeout(() => { target.textContent = 'Copiar Link'; }, 2000);
        }
    });
    
    statusFilterButtons.addEventListener('click', (e) => {
        const target = e.target;
        if (target.tagName === 'BUTTON') {
            currentPage = 0;
            currentStatusFilter = target.dataset.status;
            statusFilterButtons.querySelectorAll('button').forEach(btn => btn.classList.remove('bg-blue-600', 'text-white'));
            target.classList.add('bg-blue-600', 'text-white');
            carregarDocumentos();
        }
    });
    
    searchInput.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            currentPage = 0;
            currentSearchTerm = searchInput.value;
            carregarDocumentos();
        }, 500);
    });
    
    prevPageBtn.addEventListener('click', () => {
        if (currentPage > 0) {
            currentPage--;
            carregarDocumentos();
        }
    });
    
    nextPageBtn.addEventListener('click', () => {
        const totalPages = Math.ceil(totalDocuments / ITENS_PER_PAGE);
        if (currentPage + 1 < totalPages) {
            currentPage++;
            carregarDocumentos();
        }
    });
    
    closeModalBtn.addEventListener('click', () => detailsModal.classList.remove('active'));
    deleteCheckbox.addEventListener('change', () => {
        confirmDeleteBtn.disabled = !deleteCheckbox.checked;
        confirmDeleteBtn.classList.toggle('btn-disabled', !deleteCheckbox.checked);
    });
    cancelDeleteBtn.addEventListener('click', fecharModalExclusao);
    confirmDeleteBtn.addEventListener('click', executarExclusao);

    navToNewBtn.addEventListener('click', resetPreparationView);
    navToConsultBtn.addEventListener('click', showConsultationScreen);

    window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            detailsModal.classList.remove('active');
            deleteConfirmModal.classList.remove('active');
        }
    });

    // --- Inicialização da Aplicação ---
    async function initializeApp() {
        const importedHtml = localStorage.getItem('importedHtml');
        const originalUrl = localStorage.getItem('originalUrl');

        if (importedHtml && originalUrl) {
            localStorage.removeItem('importedHtml');
            localStorage.removeItem('originalUrl');
            
            showInitialView(); 
            const initialViewContent = document.getElementById('initial-view');
            initialViewContent.innerHTML = `<div class="text-center py-8"><p class="text-lg">Processando documento importado do ERP...</p><div class="loader mt-4 mx-auto"></div></div>`;

            try {
                const { path, name } = await db.convertHtmlToPdf(importedHtml, originalUrl);
                await startPreparationProcess(path, name, originalUrl);
            } catch (error) {
                alert(`Erro ao processar o documento importado: ${error.message}`);
                showInitialView();
            }
        } else {
            showInitialView();
        }
    }

    initializeApp();
});
```

---
### **Passo 4: Publique e Crie o Bookmarklet**

1.  **Publique as Alterações:**
    * Substitua os arquivos `js/supabaseService.js` e `js/admin.js`.
    * Envie as alterações para o GitHub (`commit` e `push`).
    * Faça o deploy da nova função de backend:
        ```bash
        supabase functions deploy html-to-pdf --no-verify-jwt
        ```

2.  **Crie o Bookmarklet (O "Agente Infiltrado"):**
    * Abra o gerenciador de favoritos do seu navegador.
    * Crie um novo favorito.
    * No campo **Nome**, digite: `Importar para Assinador`
    * No campo **URL** (ou Endereço), cole o código abaixo **em uma única linha**:
        ```javascript
        javascript:(function(){localStorage.setItem('originalUrl', window.location.href);localStorage.setItem('importedHtml', document.documentElement.outerHTML);window.open('https://altnixtecnologia.github.io/assinador-os/index.html', '_blank');})();
        

